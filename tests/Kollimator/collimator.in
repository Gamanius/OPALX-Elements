OPTION, ECHO=FALSE;
OPTION, PSDUMPFREQ=1;

TITLE,STRING="Collimator simulation";

Edes   = 0.13;
gamma  = (Edes+PMASS)/PMASS;
beta   = sqrt(1-(1/gamma^2));
gambet = gamma*beta;
P0     = gamma*beta*PMASS;
brho   = (PMASS*1.0e9*gambet) / CLIGHT;
rf     = 50.6328e6;  //need to be confirmed

VALUE,{gamma,brho,Edes,beta,gambet};


KX1IPHYS: SURFACEPHYSICS, TYPE="COLLIMATOR", MATERIAL="Graphite";

ECOLL1: ECOLLIMATOR, L=0.04, ELEMEDGE=0.01, XSIZE=0.003, YSIZE=0.003, OUTFN="ECOLL1.h5" , SURFACEPHYSICS=KX1IPHYS, DX=0, DY=0, DZ=0;

//ECOLL2: ECOLLIMATOR, L=0.02, ELEMEDGE=0.05, XSIZE=0.003, YSIZE=0.003, OUTFN="ECOLL2.h5", SURFACEPHYSICS=KX1IPHYS, DX=0, DY=0, DZ=0;

DEGPHYS_Wedge1 :  SURFACEPHYSICS, TYPE="DEGRADER", MATERIAL="GraphiteR6710";
Wedge1: DEGRADER, L=0.0148363, ZSIZE= 0.0148363, OUTFN="Wedge1.h5", SURFACEPHYSICS=DEGPHYS_Wedge1 , ELEMEDGE=0.01;
Deg_D1: DRIFT, L=0.02, ELEMEDGE=0.3;




//M0ecoll: Monitor, L=0.001, ELEMEDGE=0.01, OUTFN="M0-ecoll.h5";
//M0ecoll: Monitor, L=0.001, ELEMEDGE=0.008, OUTFN="M0-ecoll.h5";
//M1: Monitor, L=0.001, ELEMEDGE=0.07, OUTFN="M1-ecoll.h5";

//COLTEST: LINE=(M0ecoll,ECOLL,M1ecoll);
//COLTEST: LINE=(ECOLL1,ECOLL2);
COLTEST: LINE=(ECOLL1,M1);

//COLTEST: LINE=(Wedge1,Deg_D1);


D1: DISTRIBUTION, DISTRIBUTION=GAUSS,
SIGMAX=  5.0e-03,   SIGMAPX=0.0,  CORRX=0.0,
SIGMAY=  5.0e-03,   SIGMAPY=0.0,  CORRY=0.0,
T     =  0.005,     SIGMAT= 0.0005, 
PT    =  Edes*1E9, SIGMAPT=0.0, CORRT=0.0, R61=0.0;

FS1:FIELDSOLVER, FSTYPE=NONE, MX=64, MY=64, MT=64, 
                 PARFFTX=true, PARFFTY=true, PARFFTT=false,
                 BCFFTX=open, BCFFTY=open, BCFFTT=open, 
                 BBOXINCR=1, GREENSF=STANDARD;

BEAM1: BEAM, PARTICLE=PROTON, PC=P0, NPART=100000, BCURRENT=2.0e-03, BFREQ=rf, CHARGE=1;

SELECT, LINE=COLTEST;

TRACK, LINE=COLTEST, BEAM=BEAM1, MAXSTEPS=300,  DT=1.0e-12;
 RUN, METHOD = "PARALLEL-T", BEAM=BEAM1, FIELDSOLVER=FS1, DISTRIBUTION=D1;
ENDTRACK;

STOP;
