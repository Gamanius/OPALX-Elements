\begin{figure}[!htb]
  \centering
 \begin{tikzpicture}[scale=0.7,transform shape]

  % Draw diagram elements
  \path \diagramstep {1}{push particles};
  \path (p1.south)+(0.0,-1.0) \diagramstep{2}{convert position to local coordinate system of element ($K_s \rightarrow K \rightarrow K'_n$)};
  \path (p2.south)+(0.0,-1.0) \diagramstep{3}{compute external field};
  \path (p3.south)+(0.0,-1.0) \diagramstep{4}{convert position/external field to beam coordinate system $K_s$ ($K'_n \rightarrow K \rightarrow K_s$)};
  \path (p4.south)+(0.0,-1.0) \diagramstep{5}{convert position/momentum to beam coordinate system $K_{sc}$ ($K_s \rightarrow K_{sc}$)};
  \path (p5.south)+(0.0,-1.0) \diagramstep{6}{compute space charge};
  \path (p6.south)+(0.0,-1.0) \diagramstep{7}{convert position/momentum/Coulomb field to beam coordinate system $K_s$ ($K_{sc} \rightarrow K_s$)};
  \path (p7.south)+(0.0,-1.0) \diagramstep{8}{kick particles};
  \path (p8.south)+(0.0,-1.0) \diagramstep{9}{push particles};
  \path (p9.south)+(0.0,-1.0) \diagramstep{11}{compute statistics};

  % Draw arrows between elements
  \path [line] (p1.south) -- node [above] {} (p2);
  \path [line] (p2.south) -- node [above] {} (p3);
  \path [line] (p3.south) -- node [above] {} (p4);
  \path [line] (p4.south) -- node [above] {} (p5);
  \path [line] (p5.south) -- node [above] {} (p6);
  \path [line] (p6.south) -- node [above] {} (p7);
  \path [line] (p7.south) -- node [above] {} (p8);
  \path [line] (p8.south) -- node [above] {} (p9);
  \path [line] (p9.south) -- node [above] {} (p11);
  \path [line] (p11.south) -- +(0.0, -0.5) -- +(-5.0,-0.5) |- (0.0, 1.0) -- (p1);

  \node[anchor=center,text width=4cm] at ($(p4.east)+(3.0,1.5)$) (nodeA) {Loop over all elements that influence the particles at the current position along reference trajectory};

  \path [line] ($(p4.south)+(0.25,-0.25)$) -- +(4.0, -0.0) |- ($(p2.north)+(0.25,0.25)$);

%  \path [line,
%                  postaction={decorate},
%                  decoration={text along path,
%                  text= for all elements,
%                  text align={left indent={0.7\dimexpr\pgfdecoratedpathlength\relax}}
%                  }
%  ] (p4.west) -- +(-3.0, -0.0) -- +(-3.0, 3.0) -- (p2.west);
\end{tikzpicture}
  \caption{Schematic workflow of \opalt's execute method.}
  \label{fig:OPALTSchemeSimple}
\end{figure}